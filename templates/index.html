<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Estado de Cripto</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        --accent: #ffb703;
      }

      body {
        margin: 0;
        padding: 2rem;
        background: #0f172a;
        color: #e2e8f0;
      }

      h1,
      h2 {
        margin: 0;
        font-size: 2rem;
      }

      h2 {
        font-size: 1.4rem;
      }

      .stack {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .card {
        background: #1e293b;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.4);
        max-width: 720px;
      }

      .device-header {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }

      th {
        text-align: left;
        font-size: 0.9rem;
        color: #94a3b8;
        font-weight: 500;
      }

      td {
        padding: 0.75rem 0 0.75rem 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      .price {
        font-size: 1.2rem;
        font-weight: 600;
      }

      .change {
        font-weight: 600;
      }

      .change.positive {
        color: #4ade80;
      }

      .change.negative {
        color: #fb7185;
      }

      .meta {
        display: flex;
        gap: 1rem;
        align-items: center;
        color: #94a3b8;
        font-size: 0.9rem;
      }

      .chart-wrapper {
        width: 100%;
        height: clamp(220px, 35vh, 360px);
        margin-top: 1.5rem;
        position: relative;
      }

      .metrics-group {
        margin-top: 1.25rem;
        padding: 1rem;
        border-radius: 0.75rem;
        background: rgba(15, 23, 42, 0.45);
        border: 1px solid rgba(148, 163, 184, 0.18);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .highlight {
        margin-top: 1.5rem;
        padding: 1.25rem;
        border-radius: 0.75rem;
        background: linear-gradient(120deg, rgba(248, 4, 33, 0.25), rgba(15, 23, 42, 0.65));
        border: 1px solid rgba(248, 4, 33, 0.35);
      }

      .highlight .label {
        font-size: 0.85rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: #fecdd3;
        margin-bottom: 0.35rem;
      }

      .highlight .value {
        font-size: 2rem;
        font-weight: 700;
        color: #f8fafc;
      }

      .metric-row {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        font-size: 0.85rem;
        color: #cbd5f5;
      }

      .metric-row .label {
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #94a3b8;
        font-size: 0.65rem;
      }

      .metric-row .value {
        font-weight: 600;
        font-size: 0.9rem;
      }

      .error {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        background: rgba(251, 113, 133, 0.15);
        color: #fecdd3;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  </head>
  <body>
    <div class="stack">
      <section class="card">
        <h1>Mercados y acciones</h1>
        <div class="meta">
          <div>
            Última actualización:
            <span id="updated-at">{{ updated_at }}</span>
          </div>
        </div>

        <div id="error" class="error" style="display: none"></div>

        <table>
          <thead>
            <tr>
              <th>Activo</th>
              <th>Precio (USD)</th>
              <th>Variación 24h</th>
            </tr>
          </thead>
          <tbody id="prices-body"></tbody>
        </table>
      </section>

      <section class="card" id="device-card" style="display: none">
        <div class="device-header">
          <h2 id="device-title">AxeOS</h2>
          <div id="device-subtitle" class="meta"></div>
        </div>
        <div id="device-highlight" class="highlight" style="display: none">
          <div class="label" id="highlight-label"></div>
          <div class="value" id="highlight-value"></div>
        </div>
        <div class="metrics-group" id="device-metrics"></div>
      </section>

      <section class="card" id="pi-card" style="display: none">
        <div class="device-header">
          <h2 id="pi-title">Raspberry Pi</h2>
          <div id="pi-subtitle" class="meta"></div>
        </div>
        <div id="pi-highlight" class="highlight" style="display: none">
          <div class="label" id="pi-highlight-label"></div>
          <div class="value" id="pi-highlight-value"></div>
        </div>
        <div class="chart-wrapper" id="pi-chart-wrapper" style="display: none">
          <canvas id="pi-chart"></canvas>
        </div>
        <div class="metrics-group" id="pi-metrics"></div>
      </section>
    </div>

    <script>
      const initialData = {{ initial_data | tojson }};
      const initialError = {{ initial_error | tojson }};
      const initialSystem = {{ initial_system | tojson }};
      const initialPi = {{ initial_pi | tojson }};
      const initialPiHistory = {{ initial_pi_history | tojson }};
      const pricesBody = document.getElementById("prices-body");
      const errorBox = document.getElementById("error");
      const updatedAt = document.getElementById("updated-at");
      const deviceCard = document.getElementById("device-card");
      const deviceTitle = document.getElementById("device-title");
      const deviceSubtitle = document.getElementById("device-subtitle");
      const deviceMetrics = document.getElementById("device-metrics");
      const deviceHighlight = document.getElementById("device-highlight");
      const highlightLabel = document.getElementById("highlight-label");
      const highlightValue = document.getElementById("highlight-value");
      const piCard = document.getElementById("pi-card");
      const piTitle = document.getElementById("pi-title");
      const piSubtitle = document.getElementById("pi-subtitle");
      const piMetrics = document.getElementById("pi-metrics");
      const piHighlight = document.getElementById("pi-highlight");
      const piHighlightLabel = document.getElementById("pi-highlight-label");
      const piHighlightValue = document.getElementById("pi-highlight-value");
      const piChartWrapper = document.getElementById("pi-chart-wrapper");
      const piChartCanvas = document.getElementById("pi-chart");
      let piChart = null;

      const formatter = new Intl.NumberFormat("es-ES", {
        style: "currency",
        currency: "USD",
        maximumFractionDigits: 2,
      });

      function renderRows(items) {
        pricesBody.innerHTML = "";
        items.forEach((item) => {
          const changeClass =
            item.change === null || item.change === undefined
              ? ""
              : item.change >= 0
              ? "positive"
              : "negative";
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.name}</td>
            <td class="price">${
              item.price === null || item.price === undefined
                ? "—"
                : formatter.format(item.price)
            }</td>
            <td class="change ${changeClass}">${
            item.change === null || item.change === undefined
              ? "—"
              : item.change.toFixed(2) + "%"
          }</td>
          `;
          pricesBody.appendChild(row);
        });
      }

      function renderMetricsCard(data, elements) {
        const { card, titleEl, subtitleEl, metricsEl, highlightEl, highlightLabelEl, highlightValueEl, defaultTitle, formatSubtitle } = elements;
        const hasMetrics = Array.isArray(data?.metrics) && data.metrics.length > 0;
        const hasHighlight = !!(data?.highlight && data.highlight.value);

        if (!hasMetrics && !hasHighlight) {
          card.style.display = "none";
          if (metricsEl) metricsEl.innerHTML = "";
          return;
        }

        card.style.display = "block";
        const meta = data?.meta || {};
        if (titleEl) {
          titleEl.textContent = meta.hostname || defaultTitle;
        }
        if (subtitleEl) {
          const subtitle = formatSubtitle ? formatSubtitle(meta) : "";
          subtitleEl.textContent = subtitle;
          subtitleEl.style.display = subtitle ? "block" : "none";
        }

        if (highlightEl) {
          if (data?.highlight && data.highlight.value) {
            highlightEl.style.display = "block";
            if (highlightLabelEl) {
              highlightLabelEl.textContent = data.highlight.label || "";
            }
            if (highlightValueEl) {
              highlightValueEl.textContent = data.highlight.value;
            }
          } else {
            highlightEl.style.display = "none";
          }
        }

        if (metricsEl) {
          metricsEl.innerHTML = "";
          (data?.metrics || []).forEach((metric) => {
            const row = document.createElement("div");
            row.className = "metric-row";
            row.innerHTML = `
              <span class="label">${metric.label}</span>
              <span class="value">${metric.value}</span>
            `;
            metricsEl.appendChild(row);
          });
        }
      }

      function renderSystem(system) {
        renderMetricsCard(system, {
          card: deviceCard,
          titleEl: deviceTitle,
          subtitleEl: deviceSubtitle,
          metricsEl: deviceMetrics,
          highlightEl: deviceHighlight,
          highlightLabelEl: highlightLabel,
          highlightValueEl: highlightValue,
          defaultTitle: "AxeOS",
          formatSubtitle(meta) {
            const parts = [];
            if (meta.model) parts.push(meta.model);
            if (meta.ip) parts.push(meta.ip);
            return parts.join(" • ");
          },
        });
      }

      function renderPi(pi) {
        renderMetricsCard(pi, {
          card: piCard,
          titleEl: piTitle,
          subtitleEl: piSubtitle,
          metricsEl: piMetrics,
          highlightEl: piHighlight,
          highlightLabelEl: piHighlightLabel,
          highlightValueEl: piHighlightValue,
          defaultTitle: "Raspberry Pi",
          formatSubtitle() {
            return "";
          },
        });
      }

      function normalizeHistory(history) {
        const safe = history || {};
        const length = safe.labels?.length || 0;
        const points = [];
        for (let i = 0; i < length; i += 1) {
          const label = safe.labels[i];
          if (!label) continue;
          points.push({
            x: new Date(label),
            temperature: safe.temperature?.[i] ?? null,
            cpu: safe.cpu?.[i] ?? null,
            ram: safe.ram?.[i] ?? null,
            fan: safe.fan?.[i] ?? null,
          });
        }
        return points;
      }

      function updatePiChart(history) {
        if (!piChartCanvas || !piChartWrapper) return;
        const points = normalizeHistory(history);
        if (!points.length) {
          piChartWrapper.style.display = "none";
          if (piChart) {
            piChart.data.labels = [];
            piChart.data.datasets.forEach((dataset) => (dataset.data = []));
            piChart.update("none");
          }
          return;
        }

        piChartWrapper.style.display = "block";
        const labels = points.map((point) => point.x);
        const tempData = points.map((point) => ({ x: point.x, y: point.temperature }));
        const cpuData = points.map((point) => ({ x: point.x, y: point.cpu }));
        const ramData = points.map((point) => ({ x: point.x, y: point.ram }));
        const fanData = points.map((point) => ({ x: point.x, y: point.fan }));

        if (!piChart) {
          const ctx = piChartCanvas.getContext("2d");
          piChart = new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Temp (°C)",
                  data: tempData,
                  borderColor: "#fb923c",
                  backgroundColor: "rgba(251, 146, 60, 0.2)",
                  yAxisID: "temp",
                  spanGaps: true,
                  tension: 0.3,
                },
                {
                  label: "CPU (%)",
                  data: cpuData,
                  borderColor: "#0ea5e9",
                  backgroundColor: "rgba(14, 165, 233, 0.2)",
                  yAxisID: "percent",
                  spanGaps: true,
                  tension: 0.3,
                },
                {
                  label: "RAM (%)",
                  data: ramData,
                  borderColor: "#22c55e",
                  backgroundColor: "rgba(34, 197, 94, 0.2)",
                  yAxisID: "percent",
                  spanGaps: true,
                  tension: 0.3,
                },
                {
                  label: "Ventilador (%)",
                  data: fanData,
                  borderColor: "#f472b6",
                  backgroundColor: "rgba(244, 114, 182, 0.2)",
                  yAxisID: "percent",
                  spanGaps: true,
                  tension: 0.3,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: "index",
                intersect: false,
              },
              plugins: {
                legend: {
                  labels: { color: "#cbd5f5" },
                },
              },
              scales: {
                x: {
                  type: "time",
                  time: { tooltipFormat: "HH:mm", displayFormats: { minute: "HH:mm" } },
                  ticks: { color: "#94a3b8" },
                  grid: { color: "rgba(148, 163, 184, 0.2)" },
                },
                temp: {
                  type: "linear",
                  position: "left",
                  title: { display: true, text: "°C", color: "#94a3b8" },
                  ticks: { color: "#94a3b8" },
                  grid: { color: "rgba(148, 163, 184, 0.2)" },
                },
                percent: {
                  type: "linear",
                  position: "right",
                  min: 0,
                  max: 100,
                  title: { display: true, text: "%", color: "#94a3b8" },
                  ticks: { color: "#94a3b8" },
                  grid: { drawOnChartArea: false },
                },
              },
            },
          });
        } else {
          piChart.data.labels = labels;
          piChart.data.datasets[0].data = tempData;
          piChart.data.datasets[1].data = cpuData;
          piChart.data.datasets[2].data = ramData;
          piChart.data.datasets[3].data = fanData;
          piChart.update("none");
        }
      }

      function renderError(message) {
        if (message) {
          errorBox.style.display = "block";
          errorBox.textContent = message;
        } else {
          errorBox.style.display = "none";
          errorBox.textContent = "";
        }
      }

      async function refresh() {
        try {
          const response = await fetch("/api/prices");
          const payload = await response.json();

          if (!response.ok) {
            throw new Error(payload.error || "Error desconocido");
          }

          renderRows(payload.data || []);
          renderSystem(payload.system);
          renderPi(payload.pi);
          updatePiChart(payload.pi_history);
          renderError(payload.error || "");
          updatedAt.textContent = new Date(payload.updated_at).toLocaleTimeString(
            "es-ES",
            { hour: "2-digit", minute: "2-digit", second: "2-digit" }
          );
        } catch (err) {
          renderError(err.message);
        }
      }

      renderRows(initialData || []);
      renderSystem(initialSystem);
      renderPi(initialPi);
      updatePiChart(initialPiHistory);
      renderError(initialError);

      refresh();
      setInterval(refresh, 10000);
    </script>
  </body>
</html>
