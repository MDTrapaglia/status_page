<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Estado de Cripto</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        --accent: #ffb703;
      }

      body {
        margin: 0;
        padding: 2rem;
        background: #0f172a;
        color: #e2e8f0;
      }

      h1 {
        margin-top: 0;
        margin-bottom: 0.5rem;
        font-size: 2rem;
      }

      .card {
        background: #1e293b;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.4);
        max-width: 720px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }

      th {
        text-align: left;
        font-size: 0.9rem;
        color: #94a3b8;
        font-weight: 500;
      }

      td {
        padding: 0.75rem 0 0.75rem 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      .price {
        font-size: 1.2rem;
        font-weight: 600;
      }

      .change {
        font-weight: 600;
      }

      .change.positive {
        color: #4ade80;
      }

      .change.negative {
        color: #fb7185;
      }

      .meta {
        display: flex;
        gap: 1rem;
        align-items: center;
        color: #94a3b8;
        font-size: 0.9rem;
      }

      .error {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        background: rgba(251, 113, 133, 0.15);
        color: #fecdd3;
      }

      button {
        appearance: none;
        border: none;
        border-radius: 999px;
        padding: 0.5rem 1.25rem;
        font-weight: 600;
        cursor: pointer;
        background: var(--accent);
        color: #0f172a;
      }
    </style>
  </head>
  <body>
    <main class="card">
      <h1>Mercado Cripto</h1>
      <div class="meta">
        <div>
          Última actualización:
          <span id="updated-at">{{ updated_at }}</span>
        </div>
        <button id="refresh-btn">Actualizar</button>
      </div>

      <div id="error" class="error" style="display: none"></div>

      <table>
        <thead>
          <tr>
            <th>Activo</th>
            <th>Precio (USD)</th>
            <th>Variación 24h</th>
          </tr>
        </thead>
        <tbody id="prices-body"></tbody>
      </table>
    </main>

    <script>
      const initialData = {{ initial_data | tojson }};
      const initialError = {{ initial_error | tojson }};
      const pricesBody = document.getElementById("prices-body");
      const errorBox = document.getElementById("error");
      const updatedAt = document.getElementById("updated-at");
      const refreshBtn = document.getElementById("refresh-btn");

      const formatter = new Intl.NumberFormat("es-ES", {
        style: "currency",
        currency: "USD",
        maximumFractionDigits: 2,
      });

      function renderRows(items) {
        pricesBody.innerHTML = "";
        items.forEach((item) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.name}</td>
            <td class="price">${
              item.price === null || item.price === undefined
                ? "—"
                : formatter.format(item.price)
            }</td>
            <td class="change ${
              item.change >= 0 ? "positive" : "negative"
            }">${
            item.change === null || item.change === undefined
              ? "—"
              : item.change.toFixed(2) + "%"
          }</td>
          `;
          pricesBody.appendChild(row);
        });
      }

      function renderError(message) {
        if (message) {
          errorBox.style.display = "block";
          errorBox.textContent = message;
        } else {
          errorBox.style.display = "none";
          errorBox.textContent = "";
        }
      }

      async function refresh() {
        try {
          refreshBtn.disabled = true;
          const response = await fetch("/api/prices");
          const payload = await response.json();

          if (!response.ok || payload.error) {
            throw new Error(payload.error || "Error desconocido");
          }

          renderRows(payload.data);
          renderError("");
          updatedAt.textContent = new Date(payload.updated_at).toLocaleTimeString(
            "es-ES",
            { hour: "2-digit", minute: "2-digit", second: "2-digit" }
          );
        } catch (err) {
          renderError(err.message);
        } finally {
          refreshBtn.disabled = false;
        }
      }

      if (initialData?.length) {
        renderRows(initialData);
      }

      if (initialError) {
        renderError(initialError);
      }

      refreshBtn.addEventListener("click", refresh);
      refresh();
      setInterval(refresh, 10000);
    </script>
  </body>
</html>
